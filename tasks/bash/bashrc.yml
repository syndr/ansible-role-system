---
# Configure system bashrc files
#
# Expected variables:
#   - __system_bashrc_filename: The name of the system bashrc file
#

- name: Update system bashrc files
  become: true
  block:
    - name: Bash | Configure system bashrc (configuration file)
      ansible.builtin.template:
        src: etc/{{ __system_bashrc_filename }}.j2
        dest: /etc/{{ __system_bashrc_filename }}
        owner: root
        group: root
        mode: "0644"

    - name: Bash | Configure system bashrc (directory)
      ansible.builtin.file:
        path: /etc/bashrc.d
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Bash | Find user bashrc files
      ansible.builtin.find:
        paths:
          - /home
          - /root
        patterns: ".bashrc"
        recurse: true
        hidden: true
      register: __system_user_bashrc_files

    - name: üêú Show user bashrc files
      debug:
        var: __system_user_bashrc_files
        verbosity: 1

    - name: Bash | User bashrc file sources system bashrc
      when: not system_bashrc_overwrite_existing
      loop: "{{ __system_user_bashrc_files.files }}"
      loop_control:
        loop_var: __system_user_bashrc_file
        label: "{{ __system_user_bashrc_file.path }}"
      become: true
      ansible.builtin.blockinfile:
        path: "{{ __system_user_bashrc_file.path }}"
        # Make sure this block exists in etc/skel/.bashrc.j2 template
        #  including the "ANSIBLE MANAGED BLOCK" comments so as not to
        #  break idempotency
        block: |2
          # Source global definitions
          if [ -f /etc/{{ __system_bashrc_filename }} ]; then
            . /etc/{{ __system_bashrc_filename }}
          fi
        append_newline: true
        prepend_newline: true

    - name: Bash | User utilizes system bashrc
      when: system_bashrc_overwrite_existing
      loop: "{{ __system_user_bashrc_files.files }}"
      loop_control:
        loop_var: __system_user_bashrc_file
        label: "{{ __system_user_bashrc_file.pw_name }}"
      become: true
      ansible.builtin.template:
        src: etc/skel/.bashrc.j2
        dest: "{{ __system_user_bashrc_file.path }}"
        owner: "{{ __system_user_bashrc_file.pw_name }}"
        group: "{{ __system_user_bashrc_file.gr_name }}"
        mode: "0644"

    - name: Bash | Configure bashrc user template
      become: true
      ansible.builtin.template:
        src: etc/skel/.bashrc.j2
        dest: /etc/skel/.bashrc
        owner: root
        group: root
        mode: "0644"

    - name: Bash | Root uses system bashrc
      ansible.builtin.template:
        src: etc/skel/.bashrc.j2
        dest: /root/.bashrc
        owner: root
        group: root
        mode: "0644"

    - name: Bash | Configure bash_profile template for new users
      become: true
      ansible.builtin.template:
        src: etc/skel/.bash_profile.j2
        dest: /etc/skel/.bash_profile
        owner: root
        group: root
        mode: "0644"

    - name: Bash | Find user home directories
      ansible.builtin.find:
        paths:
          - /home
          - /root
        file_type: directory
        recurse: false
      register: __system_user_home_dirs

    - name: Bash | Check if .bash_profile already sources .bashrc
      loop: "{{ __system_user_home_dirs.files }}"
      loop_control:
        loop_var: __system_user_home_dir
        label: "{{ __system_user_home_dir.path }}/.bash_profile"
      become: true
      ansible.builtin.shell:
        cmd: "grep -E '(source|\\.) .*bashrc' {{ __system_user_home_dir.path }}/.bash_profile"
      register: __system_bash_profile_has_bashrc
      failed_when: false
      changed_when: false

    - name: Bash | Ensure .bash_profile sources .bashrc for existing users
      loop: "{{ __system_user_home_dirs.files }}"
      loop_control:
        loop_var: __system_user_home_dir
        index_var: idx
        label: "{{ __system_user_home_dir.path }}/.bash_profile"
      when: __system_bash_profile_has_bashrc.results[idx].rc != 0
      become: true
      ansible.builtin.blockinfile:
        path: "{{ __system_user_home_dir.path }}/.bash_profile"
        create: true
        owner: "{{ __system_user_home_dir.pw_name }}"
        group: "{{ __system_user_home_dir.gr_name }}"
        mode: "0600"
        block: |2
          # Source .bashrc if it exists
          if [ -f ~/.bashrc ]; then
              source ~/.bashrc
          fi
        marker: "# {mark} ANSIBLE MANAGED BLOCK - Source bashrc"
        append_newline: true
        prepend_newline: true

    - name: Bash | Configure prompt
      become: true
      ansible.builtin.template:
        src: etc/bashrc.d/prompt.sh.j2
        dest: /etc/bashrc.d/prompt.sh
        owner: root
        group: root
        mode: "0644"

    - name: Bash | Configure non-login aliases (1/2)
      ansible.builtin.lineinfile:
        dest: "/etc/bashrc.d/aliases.sh"
        create: true
        owner: root
        group: root
        mode: "0644"
        line: 'alias {{ item.key }}="{{ item.value }}"'
        regexp: "^alias {{ item.key }}="
      with_dict: "{{ system_bash_aliases }}"

    - name: Bash | Configure non-login aliases (2/2)
      ansible.builtin.template:
        src: etc/bashrc.d/coloraliases.sh.j2
        dest: /etc/bashrc.d/coloraliases.sh
        owner: root
        group: root
        mode: "0644"

